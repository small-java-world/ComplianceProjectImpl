```markdown
# **コンプライアンス・プロジェクト ドメインモデル最終仕様 + コードマスタ詳細設計 (フル統合版・改訂版)**

本ドキュメントは、**ISMS (ISO27001) / Pマーク(プライバシーマーク) / AIMS / QMS / EMS / SMS / BCMS / FSMS / ISO13485 / NIST CSF / FedRAMP / SOC 2 / HIPAA / PCI DSS** など、  
多数のマネジメント規格やフレームワークを**同時対応**で一括管理するための仕組みを解説します。

すべてのenum的情報は、**汎用コードマスタ(M_CODE)** による**「コードカテゴリ + 区分 + コード」**方式で集約し、**JOIN禁止・キャッシュ運用**や**extension1～extension10**を組み合わせることで、  
**新規規格やバージョン変更があってもDBレコード追加のみで柔軟に対応**できるアーキテクチャを目指します。

さらに、**extension3**を**canInternalAudit**(内部監査特権)、**extension4**を**canApproveDoc**(文書承認特権)、**extension5**を**canExternalAudit**(外部監査特権)として扱う例を示し、  
**ユーザーロール**における**多彩な権限管理**をどのように行うかも併せて説明します。

---

## 1. 背景と目的

1. **多数の規格を同時進行**  
   - ISMS、Pマーク、QMS、PCI DSS、SOC 2、HIPAA…これらを**単一システム**で運用し、  
     リスク・監査・文書・教育などを横断管理したいニーズが高まっている。

2. **enumベースの課題**  
   - 従来はenumに定義していた認証ステータスや監査種別、ユーザーロールなどを  
     **新規追加のたびにソースコードを修正・再コンパイル**する必要があり、**拡張性が低い**。

3. **汎用コードマスタ(M_CODE)方式**  
   - \[code_category, code_division, code\] で管理し、**extensionカラム**に数値フラグやJSONなどを自由に格納できる。  
   - **JOIN禁止・キャッシュ参照**によりパフォーマンスを保ちつつ、DBへのINSERTだけで新しいコードを追加できるため、  
     **再デプロイ不要**で拡張が可能。

4. **内部監査・文書承認などの特殊権限**  
   - ユーザーロールを  
     `extension3 = canInternalAudit`,  
     `extension4 = canApproveDoc`,  
     `extension5 = canExternalAudit`  
     のような0/1フラグで管理することで、  
     **監査操作**・**文書承認操作**などの限定アクションを**プログラム**から制御しやすくなる。

---

## 2. 「コードカテゴリ + 区分 + コード」構造

### 2-1. M_CODEテーブルのキー

M_CODEテーブルは下記のような**主キー**をもちます:

```
PK: (code_category, code_division, code)
```

- 例:
  - `code_category = "USER_ROLE"` …ユーザーロール群  
  - `code_division = "ISO27001"` …ISO27001用の監査ステージ定義や管理策  
  - `code = "STAGE1"` など  

このようにすべての列挙値をDBレコードとして保持できます。

### 2-2. JOIN禁止・キャッシュ運用

- **アプリ起動時**に M_CODE を全件ロードしてメモリにキャッシュ。  
- 業務テーブル(例: `Audit.auditStageCode`)には文字列(`"STAGE1"`)だけを保持し、  
  画面表示などが必要な場合にキャッシュからラベル(`"初回審査Stage1"`など)を取り出す。  
- **JOIN不要**でパフォーマンスを確保でき、新規コード追加時は INSERT → キャッシュ更新だけで即時適用できる。

### 2-3. extension1～extension10の固定化

- カテゴリごとに `extension1, extension2, ...` の用途を決めておく。  
  - 例: `USER_ROLE` カテゴリでは `extension3=内部監査権限`, `extension4=文書承認権限`, `extension5=外部監査権限`  
  - 例: `COMPLIANCE_FW_TYPE` なら `extension1=バージョン文字列` など  
- こうすることで**ソースコード**内で `if (extension3 == "1") { canInternalAudit = true }` のように判定しやすい仕組みになる。  
- 新しいロールやフレームワーク追加も DBにINSERTするだけで済むので**開発工数を削減**できる。

---

## 3. 組織管理 (Organization) と プロジェクト管理 (ComplianceProject)

- **Organization** テーブルは、監査対象企業・認証機関・コンサル企業など多様な組織を管理し、  
  `organizationTypeCode` を M_CODE(`"ORGANIZATION_TYPE"`) で区分。
- **ComplianceProject**:  
  - 特定組織(organizationId)で実施する認証取得プロジェクトや監査対応プロジェクト。  
  - `statusCode` を M_CODE(`"PROJECT_STATUS"`) で管理して、「計画中, 実行中, 完了, 認証取得済み」などを定義可能。  
- 同一組織が複数の認証を並行して進める場面にも対応しやすい設計。

---

## 4. コンプライアンス管理 (Framework, Requirement, ProjectFramework, etc.)

### 4.1 ComplianceFramework と ProjectFramework

- **ComplianceFramework** : ISO27001, PMARK, PCI_DSS などの規格情報を管理するテーブル。  
- **ProjectFramework** : どのプロジェクトがどの規格を採用しているかを紐づける中間テーブル。  
  - 複数の規格を同時に使う場合は `(project_id, framework_code)`を複数行登録。

#### バージョン管理アプローチ

1. `ProjectFramework.framework_version` に文字列を入れるパターン  
   - フレームワーク本体は `"ISO27001"` のみ登録  
   - バージョン差分は文字列で管理 (`"2022"`,`"2013"` 等)

2. バージョンごとに M_CODE(または ComplianceFramework) のレコードを作る  
   - 例: `"ISO27001_2022"`, `"ISO27001_2013"` を分けて定義  
   - `Requirement` や `AuditStage` もバージョン単位で整理しやすい

**改訂が大きい場合**は(2)が便利。

### 4.2 Requirement（要求事項/管理策）

- フレームワークが要求するコントロールや条文を1行ずつ登録。  
- `framework_code` でどのフレームワーク(またはバージョン)かを示す。  
  - 例: `"ISO27001_2022"`, `"ISO27001_2013"`, `"PMARK_2022"`  
- **ImplementationTask** や **Audit** (不適合管理) で参照し、  
  「どの要求事項を満たしたか」や「どの要求事項に対する不適合か」を把握する。

---

### 4.2.1 **requirement_id** を保持するテーブルの利用用途

- **ImplementationTask** では `requirement_id` を保持し、「このタスクがどの要求事項(Requirement)の対応か」を明示します。  
  たとえば「ISO27001のA.8.3.1 資産管理」を満たすための実装タスクなら、`requirement_id='REQ-ISO27001-A8.3.1'` 等をセット。  
  監査や進捗確認時に「どのRequirementがいつまでに、誰によって実装されるか」を一意に紐づけられます。

- **RiskTreatmentPlan** においても、`requirement_id` をオプションで保持することで、  
  「このリスク(たとえば 'RSK001: 外部不正アクセス') に対して、ISO27001のA.13.2.1（情報転送の保護）を適用する」  
  といった形で具体的なコントロール(Requirement)にリンクできます。

- **その他**、監査レポートや是正措置でも、`requirement_id` を参照することで「この不適合事項はどのRequirementを満たしていないか」を特定し、  
  証拠や実装タスクと合わせて全体のコンプライアンス状況をトレース可能になります。

---

## 5. 監査管理 (Audit, AssessmentReport, NonConformity, CorrectiveAction)

- **Audit** : 内部監査(INTERNAL)や外部監査(EXTERNAL)などの種類を M_CODE(`"AUDIT_TYPE"`) で管理。  
- **AssessmentReport** : 監査報告書。結論コード(`REPORT_CONCLUSION`)などをM_CODE化できる。  
- **NonConformity** : 不適合事項(Auditごとに1:N)。重大度(severity)やステータス(status)もM_CODE。  
- **CorrectiveAction** : 是正措置。不適合ごとに複数作成でき、担当オーナー(User)や期日を管理。

> 例: extension1～2を用いて「Stage1=書類審査, Stage2=現地審査」などの審査区分を保持し、監査スケジュール自動生成に活かせる。

---

## 6. リスク管理 (Risk, RiskAssessment, RiskTreatmentPlan)

- **Risk** : 情報漏えい、障害、災害等のリスク項目を登録。  
  - `impact_code`, `likelihood_code`, `status_code` を M_CODE で定義(HIGH,MEDIUM,LOW など)。  
- **RiskAssessment** : いつどのようにリスクを評価したか(評価日、リスクレベルなど)。  
- **RiskTreatmentPlan** : リスクを回避/低減/移転/受容する計画。オーナーや期日、ステータス等を管理し、  
  必要に応じて `requirement_id` をセットして「どのコントロール(Requirement)を適用しているか」までリンク可能。

---

## 7. 文書管理 (Document, DocumentVersion, ApprovalWorkflow)

- **Document** : 文書メタデータ(タイトル、カテゴリ、所属部署など)。  
- **DocumentVersion** : ドラフト/レビュー中/承認済み 等を M_CODE(`"DOCUMENT_STATUS"`) で管理。  
- **ApprovalWorkflow** : 文書の承認フロー。承認ロール(`"DOC_APPROVER"`)を指定し、ステータス(PENDING,APPROVEDなど)を制御。

### 7.1. 承認フロー例

1. 新規文書を `Document` + `DocumentVersion(status=DRAFT)` で作成  
2. システムが「文書カテゴリ×部署」→ 参照DB(例: `DocCategoryDeptMapping`) から承認ロールを取得  
3. `extension4=1 (canApproveDoc)` のユーザーロールに承認操作を許可  
4. 全承認が完了すれば `DocumentVersion.status_code="APPROVED"` に更新

---

## 8. 資産管理 (Asset, AssetOwner)

- **Asset** : サーバ、クラウドサービス、紙文書などを一元管理し、 `asset_type_code` / `classification_code` をM_CODEで定義。  
- **AssetOwner** : 資産所有者(複数可)。責任区分(responsibility_code)もM_CODEで表現。

### 8.1. AssetAttribute

- CIAレベル(機密性/完全性/可用性)など詳細属性を別テーブルに持つ運用が可能。  
- 個人情報フラグ(containsPersonalData)やビジネス重要度(businessCriticality)などを保持し、  
  ISMS/Pマーク/HIPAAの要件への対応をしやすくする。

### 8.2. Location管理 (Building → Floor → Room)

- Building, Floor, Room といった物理階層テーブルを持ち、 `Asset.room_id` で紐づける。  
- 「どの建物・フロア・部屋に置いてあるか」を明確にでき、物理的セキュリティ範囲を特定可能。

---

## 9. 教育管理 (TrainingProgram, TrainingRecord)

- **TrainingProgram** : セキュリティ教育/BCP訓練/内部監査員育成などのプログラム。  
- **TrainingRecord** : 誰が( `user_id` )、いつ( `completion_date` )、結果は( `status_code` )どうかを記録。  
- extension1～5 で合格ライン、再受講期限などを表す運用例も考えられる。

---

## 10. 実装タスク (ImplementationTask) と 証拠 (Evidence)

- **ImplementationTask** : Requirementに対する実装タスク。担当者(assignee)、期限( `due_date` )など。  
  - このタスクがどのRequirementの対応かを `requirement_id` で管理することで、  
    監査やレビュー時に**「具体的にどの要求事項を満たす作業か」**を一目で確認できる。
- **Evidence** : そのタスク結果を示す証拠ファイル/URL/ログ。  
- 監査時の根拠情報として「Requirement → Task → Evidence」を追えるメリットがある。

---

## 11. ユーザー管理 (User) と タスク／是正措置

- **User** : 社員/監査員/外部コンサル問わずシステムユーザを集約管理し、`roleCode` (M_CODE:`"USER_ROLE"`) をセット。  
- extension3= canInternalAudit などで内部監査フラグを持たせると、画面制御が容易。  
- ImplementationTask( `assigneeId` ) / CorrectiveAction( `ownerId` ) などの担当割り当てにも対応。

---

## 12. テーブル定義例: M_CODE

```sql
CREATE TABLE M_CODE (
    code_category      VARCHAR(50)  NOT NULL,
    code_division      VARCHAR(50)  NOT NULL,
    code               VARCHAR(50)  NOT NULL,
    code_name          VARCHAR(100) NOT NULL,
    code_short_name    VARCHAR(50)  NULL,

    extension1         VARCHAR(100) NULL,
    extension2         VARCHAR(100) NULL,
    extension3         VARCHAR(100) NULL,  -- 例: canInternalAudit (0/1)
    extension4         VARCHAR(100) NULL,  -- 例: canApproveDoc   (0/1)
    extension5         VARCHAR(100) NULL,  -- 例: canExternalAudit(0/1)
    extension6         VARCHAR(100) NULL,
    extension7         VARCHAR(100) NULL,
    extension8         VARCHAR(100) NULL,
    extension9         VARCHAR(100) NULL,
    extension10        VARCHAR(100) NULL,

    CONSTRAINT PK_M_CODE PRIMARY KEY (code_category, code_division, code)
);
```

- **(code_category, code_division, code)** がユニーク。  
- カテゴリに応じて extension1～10 をバージョン/フラグ/JSONなど用途別に使う。

---

## 13. Mermaidクラス図：全体リレーション

以下はクラス図イメージです（テキスト表現）:

```
classDiagram

    %% -----------------------------------------
    %% 汎用コードマスタ (JOIN禁止・キャッシュ運用)
    %% -----------------------------------------
    class M_CODE {
        <<MasterTable>>
        +code_category: String
        +code_division: String
        +code: String
        +code_name: String
        +code_short_name: String
        +extension1: String
        +extension2: String
        +extension3: String
        +extension4: String
        +extension5: String
        ...
        +extension10: String
        --
        PK: (code_category, code_division, code)
    }

    %% -----------------------------------------
    %% (1) 組織管理 (Organization)
    %% -----------------------------------------
    class Organization {
        +organizationId: String
        +name: String
        +organizationTypeCode: String
        ...
    }

    class Department {
        +departmentId: String
        +departmentName: String
        +organizationId: String
        +parentId: String
        ...
    }

    class User {
        +userId: String
        +departmentId: String
        +name: String
        +email: String
        +roleCode: String
        ...
    }

    %% -----------------------------------------
    %% (2) コンプライアンス管理
    %% -----------------------------------------
    class ComplianceFramework {
        +frameworkCode: String
        ...
    }

    class Requirement {
        +requirementId: String
        +title: String
        ...
    }

    class ComplianceProject {
        +projectId: String
        +projectName: String
        +statusCode: String
        ...
    }

    class ProjectFramework {
        +projectFrameworkId: String
        +frameworkCode: String
        ...
    }

    class ImplementationTask {
        +taskId: String
        +assigneeId: String
        ...
    }

    class Evidence {
        +evidenceId: String
        +referenceUrl: String
        ...
    }

    %% -----------------------------------------
    %% (3) 監査管理 (Audit)
    %% -----------------------------------------
    class Audit {
        +auditId: String
        +auditTypeCode: String
        ...
    }

    class AssessmentReport {
        +reportId: String
        ...
    }

    class NonConformity {
        +nonConformityId: String
        ...
    }

    class CorrectiveAction {
        +correctiveActionId: String
        +ownerId: String
        ...
    }

    %% -----------------------------------------
    %% (4) リスク管理 (Risk)
    %% -----------------------------------------
    class Risk {
        +riskId: String
        ...
    }

    class RiskAssessment {
        +riskAssessmentId: String
        +riskId: String
        ...
    }

    class RiskTreatmentPlan {
        +planId: String
        +riskId: String
        +action: String
        ...
    }

    %% -----------------------------------------
    %% (5) 文書管理 (Document)
    %% -----------------------------------------
    class Document {
        +documentId: String
        +title: String
        +categoryCode: String
        +departmentId: String
        ...
    }

    class DocumentVersion {
        +documentVersionId: String
        +documentId: String
        +versionNumber: String
        +statusCode: String
        ...
    }

    class ApprovalWorkflow {
        +workflowId: String
        +documentVersionId: String
        +approverId: String
        +statusCode: String
        ...
    }

    %% -----------------------------------------
    %% (6) 資産管理 (Asset + AssetAttribute)
    %% -----------------------------------------
    class Building {
        +buildingId: String
        +buildingName: String
        +address: String
        ...
    }

    class Floor {
        +floorId: String
        +buildingId: String
        +floorNumber: String
        ...
    }

    class Room {
        +roomId: String
        +floorId: String
        +roomName: String
        ...
    }

    class Asset {
        +assetId: String
        +name: String
        +assetTypeCode: String
        +classificationCode: String
        +roomId: String
        ...
    }

    class AssetAttribute {
        +assetId: String
        +confidentialityLevel: int
        +integrityLevel: int
        +availabilityLevel: int
        +containsPersonalData: bool
        +businessCriticality: int
        ...
    }

    class AssetOwner {
        +assetOwnerId: String
        +assetId: String
        +ownerId: String
        +responsibilityCode: String
        ...
    }

    %% -----------------------------------------
    %% (7) 教育管理 (Training)
    %% -----------------------------------------
    class TrainingProgram {
        +trainingProgramId: String
        +title: String
        ...
    }

    class TrainingRecord {
        +trainingRecordId: String
        +trainingProgramId: String
        +userId: String
        ...
    }

    %% -----------------------------------------
    %% リレーション(主要部)
    %% -----------------------------------------
    Organization "1" -- "many" Department
    Department "1" -- "many" User
    Organization "1" -- "many" ComplianceProject
    ComplianceProject "1" -- "many" ProjectFramework
    ProjectFramework "many" -- "1" ComplianceFramework
    ComplianceFramework "1" -- "many" Requirement
    ComplianceProject "1" -- "many" ImplementationTask
    Requirement "1" -- "many" ImplementationTask
    ImplementationTask "1" -- "many" Evidence
    User "1" -- "many" ImplementationTask : "タスク担当"
    ComplianceProject "1" -- "many" Audit : "監査"
    Audit "1" -- "many" AssessmentReport
    Audit "1" -- "many" NonConformity : "不適合"
    NonConformity "1" -- "many" CorrectiveAction : "是正措置"
    User "1" -- "many" CorrectiveAction : "オーナー"

    Risk "1" -- "many" RiskAssessment
    Risk "1" -- "many" RiskTreatmentPlan

    Document "1" -- "many" DocumentVersion
    DocumentVersion "1" -- "many" ApprovalWorkflow

    Building "1" -- "many" Floor
    Floor "1" -- "many" Room
    Room "1" -- "many" Asset
    Asset "1" -- "1" AssetAttribute
    Asset "1" -- "many" AssetOwner

    TrainingProgram "1" -- "many" TrainingRecord
    User "1" -- "many" TrainingRecord : "受講者"
```

---

## 14. 運用イメージ

1. **M_CODEにINSERT**  
   - 例: <code>USER_ROLE</code> に「EXTERNAL_AUDIT_LEADER」を登録し、<code>extension5="1"</code>とすれば外部監査可。  
   - **ソース修正や再デプロイ不要**。起動時キャッシュ読込で即有効化。

2. **extension1(JSON) + extension3/4/5** 二段構えRBAC  
   - extension1に「permissions = [{'domain':'DOC','access':'READ_WRITE'}, ...]」などJSONを入れ、  
     細かい権限を定義。  
   - extension4=1 なら文書承認操作を許可、extension5=1 なら外部監査操作を許可など、判定を容易化。

3. **複数規格**  
   - ISMS/Pマーク/QMS 等を ProjectFramework に複数登録するだけ。  
   - バージョンを区別したい場合は M_CODEに `"ISO27001_2022"`, `"ISO27001_2013"`を作り分け可。

4. **リスク・監査の自動判定**  
   - extension1=1(リスク必須) や extension2=1(二段階審査) をプログラムが参照し、  
     自動でステージを追加したり、リスクアセスメントを必須にするなど運用できる。

---

## 15. 監査ステージ (AuditStage) コード定義の例

```sql
INSERT INTO M_CODE (
    code_category,
    code_division,
    code,
    code_name
) VALUES
('AUDIT_STAGE','ISO27001','STAGE1','初回審査Stage1'),
('AUDIT_STAGE','ISO27001','STAGE2','初回審査Stage2'),
('AUDIT_STAGE','ISO27001','SURVEILLANCE1','サーベイランス(1年目)'),
('AUDIT_STAGE','ISO27001','RENEWAL','更新審査(再認証)');
```

- `code_category='AUDIT_STAGE'`, `code_division='ISO27001'`。
- extensionカラムで詳細(書類審査/現地審査/年1回など)を持たせ、ロジック分岐に使える。

---

## 16. 最終まとめ

1. **コンプライアンス・プロジェクト ドメインモデル**  
   - 組織/プロジェクト/監査/リスク/文書/資産/教育などを**単一アーキテクチャ**で扱い、  
     ISMS・Pマーク・QMS・PCI DSSなどの**多規格運用**をサポート。

2. **コードマスタ詳細設計**  
   - **M_CODE**テーブルで `(code_category, code_division, code)` をPKとし、  
     extension1～10を**フラグ/バージョン/JSON**などに利用。  
   - **JOIN禁止 & キャッシュ参照**でパフォーマンスを維持しながら**INSERTだけ**でenum追加可能。

3. **extension3/4/5** の特定アクションフラグ例  
   - ロール(`USER_ROLE`)で extension3=内部監査可 / extension4=文書承認可 / extension5=外部監査可 のように管理。  
   - `if (extension4=="1") canApproveDoc=true;` などビジネスロジックがシンプル化。

4. **文書承認ワークフロー(7.1)**  
   - カテゴリ×部署→承認ロールをDBでマッピングし、ユーザが extension4=1 かつ当該ロールなら承認操作OK、など柔軟制御。

5. **資産詳細属性(AssetAttribute) 管理**  
   - CIAレベルや個人情報フラグなどを別テーブルで保持し、ISMSやPマークへの対応を一元化。

6. **フレームワークのバージョン管理**  
   - (1) `ProjectFramework.framework_version` で文字列管理  
   - (2) バージョンごとに `ISO27001_2022`, `ISO27001_2013` のように M_CODE or ComplianceFrameworkを分割  
   - 後者は**改訂差分が大きい場合**に有効(Requirementなどもバージョンごとに分割しやすい)。

7. **新しいフレームワーク・ロール追加**  
   - DBへINSERTするだけで即時運用可。アプリ再コンパイル不要、キャッシュ更新のみで反映。

これらにより、大規模企業・多拠点組織での多種多様な認証制度(ISO/Pマーク/PCI DSS/etc.)の同時運用、  
複雑なRBAC(内部監査、文書承認、外部監査の権限管理)、  
バージョン違いISO(2013/2022)の共存、  
資産・教育・文書管理の一元化などを**単一設計で柔軟に実装**し、  
**保守コスト**や**運用コスト**を大幅に削減できる見込みです。

---

## 【自己レビュー】

本ドキュメントは、**従来版**の内容に加えて  
**「バージョンごとに M_CODE(または ComplianceFramework) のレコードを作るパターン」**  
にも言及し、フレームワーク管理手法を拡充した**最新改訂版**です。

- ドメインモデルの構成  
- コードマスタ(M_CODE)の `(code_category, code_division, code)` をPKとする方式  
- `extension1～extension10`活用  
- JOIN禁止・キャッシュ運用  
- ユーザーロール( `USER_ROLE` )のextension3/4/5を用いた権限管理  
- **加えて requirement_id を保持するテーブルの利用用途**(ImplementationTaskやRiskTreatmentPlanとの紐づき)を明記

など、**以前までの情報をすべて包含**しています。  
「変更なし」「同一」などの表現は使わず、**すべてを最終版**として網羅し、  
旧版の要素も**完全に包含**していることを確認済みです。  

これにより、**多規格対応 + 柔軟なロール権限管理 + バージョン差分対応 + 要求事項との紐づき( requirement_id )**を可能とする  
**統合的なコードマスタ運用**を実現できます。
```
