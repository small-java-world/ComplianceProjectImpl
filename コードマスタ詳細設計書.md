以下は、**コードマスタ(M_CODE)テーブルの主キーを `(code_category, code_division, code)` から `(code_category, code)` に変更**し、  
**code_division を通常のカラム**として扱う設計を取り入れた**最新版**の設計書です。  

ここでは、**extension1～extension10** の活用方法や **PermissionDetail** によるロール権限管理をはじめとする内容、  
あらゆるカテゴリ定義表やサンプルINSERTの解説などが含まれています。  
また、**フレームワークバージョン**を extension1 に格納する構想や、  
ISMS/Pマーク/QMS など多規格対応する場合のコード運用など、従来示されてきた情報が反映されています。  

---

# **コードマスタ詳細設計書 (PKを `(code_category, code)` に変更 + カテゴリ別拡張カラム + PermissionDetail)**

---

## **1. 概要**

本書は、以下の項目を中心とした設計方針を示します。

- **組織管理・プロジェクト管理・監査管理・リスク管理・文書管理・資産管理・教育管理**など、多様なドメインで用いられる**列挙値的情報**を一元管理するアプローチ  
- **M_CODEテーブル**上で**カテゴリ**(code_category)＋**コード**(code)を主キーとすることで、enum の追加や変更を **DB INSERT/UPDATE** だけで完了させる  
- **拡張カラム (extension1～extension10)** を通じて、フラグやバージョン、JSON などを柔軟に扱う  
- **PermissionDetail** テーブルと組み合わせ、**ユーザーロール**(USER_ROLE)を細分化権限まで管理できるRBAC（Role-Based Access Control）を実現  

特に、本設計では**主キーを `(code_category, code)` とし、`code_division` は通常カラム**として扱うよう変更し、  
拡張性とシンプルな一意制約を両立しています。

---

## **2. コードマスタ(M_CODE)の役割**

1. **列挙値の汎用管理**  
   - 例: ユーザーロール / 組織種別 / 監査種別 / 文書ステータス / リスク重大度 等  
   - かつては enum や定数クラスなどにハードコードしていた内容を**DBレコード**で保持し、**ソースコード改修の手間**を削減する。  

2. **フレームワーク差異の吸収**  
   - ISMS(ISO27001)やPマーク、QMS、PCI DSS、SOC2…など**異なるフレームワーク**が混在するときでも、  
     **extensionカラム**の利用で「リスク必須」「二段階審査必須」などの要件を**同一実装**に集約しやすい。  

3. **JOIN禁止・キャッシュ運用**  
   - コード参照はアプリ起動時に**M_CODEを全件キャッシュ**に載せ、画面表示・ロジック分岐時はキャッシュを参照。  
   - 新規追加や修正は DB への INSERT/UPDATE とキャッシュリフレッシュで即時反映可能。  

4. **ユーザーロール + PermissionDetail**  
   - `USER_ROLE` カテゴリとしてロールを定義し、**extension**カラムで基本フラグ（管理レベルなど）を付与できる。  
   - さらに、PermissionDetail テーブルを用いて、**ドメイン × 操作**単位で細かい権限を定義。  

---

## **3. テーブル構造**

### **3-1. M_CODEテーブル (コードマスタ)**

```sql
CREATE TABLE M_CODE (
    code_category      VARCHAR(50)  NOT NULL,  -- 例: "ORGANIZATION_TYPE", "USER_ROLE", "PROJECT_STATUS", etc.
    code_division      VARCHAR(50)  NOT NULL,  -- 例: "CLIENT", "CERTIFICATION_BODY", "DRAFT", "APPROVED", etc.（通常カラム扱い）
    code               VARCHAR(50)  NOT NULL,  -- 例: "01", "02", "A", etc.
    code_name          VARCHAR(100) NOT NULL,  -- 画面表示用の名称
    code_short_name    VARCHAR(50)  NULL,      -- 略称、スペースが限られる画面での表示用

    extension1         VARCHAR(100) NULL,      -- 拡張カラム1
    extension2         VARCHAR(100) NULL,      
    extension3         VARCHAR(100) NULL,      
    extension4         VARCHAR(100) NULL,      
    extension5         VARCHAR(100) NULL,      
    extension6         VARCHAR(100) NULL,
    extension7         VARCHAR(100) NULL,
    extension8         VARCHAR(100) NULL,
    extension9         VARCHAR(100) NULL,
    extension10        VARCHAR(100) NULL,

    CONSTRAINT PK_M_CODE PRIMARY KEY (code_category, code)
);
```

- **code_category + code** が一意となるようPKを設定。  
- **code_division** は必須入力だが、主キーには含まれないため、同じ code_division が他レコードに重複しても問題なし。  
- たとえば、`(code_category='USER_ROLE', code='ADMIN')` として登録する際に `code_division='SUPERUSER'` といった形で利用できる。  

### **3-2. PermissionDetailテーブル (ロール権限細分化)**

```sql
CREATE TABLE PermissionDetail (
    permission_detail_id BIGINT AUTO_INCREMENT NOT NULL,
    role_code           VARCHAR(50) NOT NULL,  -- M_CODE の code_category='USER_ROLE' に対応する code
    domain              VARCHAR(50) NOT NULL,  -- 例: "ASSET","DOCUMENT","INCIDENT","AUDIT" etc.
    asset_type          VARCHAR(50) NULL,      -- 例: "SERVER","POLICY" etc.
    access              VARCHAR(50) NOT NULL,  -- 例: "READ_ONLY","READ_WRITE","APPROVE","EXECUTE"...
    department_scope    VARCHAR(100) NULL,     
    PRIMARY KEY (permission_detail_id)
);
```

- `role_code` は M_CODE テーブルで定義したユーザーロール (例: `'ADMIN'`, `'ISMS_MANAGER'`) を参照する想定。  
- 1ロールにつき複数行を追加することで、**複数のドメイン操作**を許可。  

---

## **4. カラム仕様 (M_CODE)**

| **カラム名**     | **型**            | **必須** | **説明**                                                                                            |
|:----------------|:----------------:|:--------:|:----------------------------------------------------------------------------------------------------|
| code_category   | VARCHAR(50)      | YES      | コードの大分類。例: `"ORGANIZATION_TYPE"`, `"USER_ROLE"`, `"PROJECT_STATUS"` 等                       |
| code            | VARCHAR(50)      | YES      | コード本体。例: `"01"`, `"02"`, `"ADMIN"` など                                                       |
| code_division   | VARCHAR(50)      | YES      | 通常カラム。検索条件やグルーピング等で使用。PKには含まれない。                                      |
| code_name       | VARCHAR(100)     | YES      | 画面表示名。                                                                                        |
| code_short_name | VARCHAR(50)      | NO       | 短縮表示用の名称。                                                                                  |
| extension1～10  | VARCHAR(100)     | NO       | バージョン文字列、フラグ、JSONなど、カテゴリ別に運用ルールを定めて活用する。                        |

---

## **5. 主なコードカテゴリ**

- **ORGANIZATION_TYPE**  
- **USER_ROLE**  
- **PROJECT_STATUS**  
- **AUDIT_TYPE / AUDIT_STATUS**  
- **NON_CONFORMITY_SEVERITY**  
- **RISK_STATUS / RISK_IMPACT / RISK_LIKELIHOOD**  
- **DOCUMENT_STATUS**  
- **ASSET_TYPE / ASSET_CLASSIFICATION**  
- **TRAINING_RECORD_STATUS**  
- **COMPLIANCE_FW_TYPE**  (extension1 にバージョン文字列を格納: 例 `"ISO27001_2022"`)  
- **REPORT_TYPE / REPORT_CONCLUSION**  
- **EVIDENCE_TYPE**  
- **CHANGE_TYPE / INCIDENT_TYPE**  
- …その他のサブドメインごとに追加可能  

---

## **6. 運用方法**

1. **extensionカラム**  
   - 例: `extension1` に「フレームワークバージョン」(`"ISO27001_2022"`)を入れたり、 `extension3` に「内部監査特権(0/1)」を入れたりする。  
2. **JOIN禁止・キャッシュ参照**  
   - コードテーブルを **JOIN** せずに業務テーブルだけを検索。  
   - 画面表示時などに**キャッシュからコード名を取り出し**、ラベル変換や権限チェックを行う。  
3. **PermissionDetail** での操作権限管理  
   - ユーザーロール (`USER_ROLE`) の code をキーにして、PermissionDetail に行を登録すると、  
     どのドメインで何ができるかを細かくコントロールできる。  
4. **PKの変更**  
   - `(code_category, code)` のみでユニークにすることで、code_division の違いによってレコードが増えすぎる事態を防ぎ、  
     シンプルな運用を実現。  

---

## **7. サンプルINSERT: PROJECT_STATUS**

以下は、**PROJECT_STATUS** カテゴリに対し、5つのレコードを挿入する例です。  
`(code_category='PROJECT_STATUS', code='01')` を主キーにし、code_division には `'PREPARING'` をセット。

```sql
INSERT INTO M_CODE (
    code_category,
    code,
    code_division,
    code_name,
    code_short_name,
    extension1,
    extension2,
    extension3,
    extension4,
    extension5
) VALUES (
    'PROJECT_STATUS',
    '01',
    'PREPARING',
    '準備中',
    'Preparing',
    '0',
    '1',
    '0',
    '0',
    '0'
);

INSERT INTO M_CODE (
    code_category,
    code,
    code_division,
    code_name,
    code_short_name,
    extension1,
    extension2,
    extension3
) VALUES (
    'PROJECT_STATUS',
    '02',
    'IN_PROGRESS',
    '実行中',
    'InProgress',
    '1',   -- extension1=1 => タスク可
    '1',   -- extension2=1 => 通知要
    '0'
);
...
```

---

## **8. カテゴリ定義表の例**

### ORGANIZATION_TYPE

| code_category      | code | code_division         | code_name                  | code_short_name | extension1 | extension2 | extension3 | extension4 | extension5 | コメント                                                                              |
|:-------------------|:----:|:----------------------|:--------------------------:|:---------------:|:----------:|:----------:|:----------:|:----------:|:----------:|:---------------------------------------------------------------------------------------|
| ORGANIZATION_TYPE | 01   | CLIENT               | クライアント（被監査企業） | Client          | 1          | 1          | 1          | 0          | 2          | extension1=1(社外), extension2=1(契約必須), extension3=1(監査対象), extension5=2(二段階承認) |
| ORGANIZATION_TYPE | 02   | CERTIFICATION_BODY   | 認証機関                   | CertBody        | 1          | 0          | 0          | 1          | 1          | extension1=1(社外), extension4=1(ISO認証機関), extension5=1(一段階承認)                     |
| ORGANIZATION_TYPE | 04   | REGULATORY_AUTHORITY | 規制当局                   | Regulator       | 1          | 0          | 0          | 2          | 0          | extension1=1(社外), extension4=2(監督庁)                                                  |
| ORGANIZATION_TYPE | 05   | INTERNAL_DEPARTMENT  | 社内部署                   | InternalDept    | 0          | 0          | 0          | 0          | 0          | extension1=0(社内)                                                                       |
| ORGANIZATION_TYPE | 99   | OTHER               | その他                     | Other           | 0          | 0          | 0          | 0          | 0          | 特殊扱い不要                                                                             |

### USER_ROLE

| code_category | code | code_division               | code_name           | code_short_name | extension1 | extension2 | extension3 | コメント                                                                       |
|:-------------:|:----:|:----------------------------|:-------------------:|:---------------:|:----------:|:----------:|:----------:|:-------------------------------------------------------------------------------|
| USER_ROLE     | 01   | ADMIN                       | システム管理者       | Admin           | 1          | 4          | 0          | extension1=1(管理者), extension2=4(全権限)                                      |
| USER_ROLE     | 02   | PROJECT_MANAGER             | プロジェクト管理者   | PM              | 0          | 3          | 0          | extension2=3(管理級)                                                            |
| USER_ROLE     | 03   | AUDITOR                     | 監査員(内部/外部)    | Auditor         | 0          | 2          | 1 or 2     | extension2=2(実務), extension3=1(内部監査) or 2(外部監査)                          |
| USER_ROLE     | 09   | GENERAL_USER                | 一般ユーザー         | General         | 0          | 2          | 0          | extension2=2(実務レベル)                                                         |
| USER_ROLE     | 10   | READ_ONLY                   | 閲覧専用ユーザー     | ReadOnly        | 0          | 1          | 0          | extension2=1(参照レベル)                                                         |
| USER_ROLE     | 12   | INTERNAL_AUDIT_LEADER       | 内部監査責任者       | IntAuditLeader  | 0          | 3          | 1          | extension2=3(管理級), extension3=1(内部監査特権)                                  |
| USER_ROLE     | 13   | EXTERNAL_AUDIT_COORDINATOR  | 外部監査対応責任者   | ExtAuditCoord   | 0          | 3          | 2          | extension2=3(管理級), extension3=2(外部監査特権)                                  |
| USER_ROLE     | 99   | OTHER                       | その他               | Other           | 0          | 1          | 0          | extension2=1(参照レベル)                                                         |

### PROJECT_STATUS

| code_category   | code | code_division | code_name       | code_short_name | extension1 | extension2 | extension3 | extension4 | extension5 | コメント                                          |
|:--------------:|:----:|:-------------:|:---------------:|:---------------:|:----------:|:----------:|:----------:|:----------:|:----------:|:---------------------------------------------------|
| PROJECT_STATUS | 01   | PREPARING     | 準備中          | Preparing       | 0          | 1          | 0          | 0          | 0          | extension1=0(タスク不可), extension2=1(通知要)      |
| PROJECT_STATUS | 02   | IN_PROGRESS   | 実行中          | InProgress      | 1          | 1          | 0          | 0          | 0          | extension1=1(タスク可), extension2=1(通知要)        |
| PROJECT_STATUS | 03   | ON_HOLD       | 保留中          | OnHold          | 0          | 0          | 1          | 0          | 0          | extension3=1(再開可能)                             |
| PROJECT_STATUS | 04   | SUSPENDED     | 停止(中断)       | Suspended       | 0          | 0          | 1          | 0          | 1          | extension3=1(再開可), extension5=1(注意バナー要)    |
| PROJECT_STATUS | 05   | COMPLETED     | 完了            | Completed       | 0          | 0          | 0          | 0          | 0          |                                                   |
| PROJECT_STATUS | 06   | CERTIFIED     | 認証取得済み    | Certified       | 0          | 0          | 0          | 1          | 0          | extension4=1(認証後フェーズ)                        |
| PROJECT_STATUS | 07   | CLOSED        | クローズ        | Closed          | 0          | 0          | 0          | 0          | 0          |                                                   |
| PROJECT_STATUS | 08   | CANCELED      | 途中キャンセル  | Canceled        | 0          | 0          | 0          | 0          | 0          |                                                   |
| PROJECT_STATUS | 99   | OTHER         | その他          | Other           | 0          | 0          | 0          | 0          | 0          |                                                   |

> この他、**AUDIT_TYPE**, **AUDIT_STATUS**, **NON_CONFORMITY_SEVERITY**, **RISK_STATUS**, **DOCUMENT_STATUS**, **EVIDENCE_TYPE**, **COMPLIANCE_FW_TYPE**, **TRAINING_RECORD_STATUS**, **CHANGE_TYPE**, **INCIDENT_TYPE** なども同様の表で定義可能。  

---

## **9. PermissionDetail によるロール権限管理**

### 9-1. テーブル定義

```sql
CREATE TABLE PermissionDetail (
    permission_detail_id BIGINT AUTO_INCREMENT NOT NULL,
    role_code           VARCHAR(50) NOT NULL,
    domain              VARCHAR(50) NOT NULL,
    asset_type          VARCHAR(50) NULL,
    access              VARCHAR(50) NOT NULL,
    department_scope    VARCHAR(100) NULL,
    PRIMARY KEY (permission_detail_id)
);
```

- `role_code` が `M_CODE(code_category='USER_ROLE').code` を参照。  
- 例: `role_code='ADMIN'` のユーザは、PermissionDetail の該当行を取得→権限判定。

### 9-2. サンプル運用

```sql
-- ASSET_MANAGER ロールは、ASSET(SERVER) に対して READ_WRITEが可能
INSERT INTO PermissionDetail (
    role_code, domain, asset_type, access, department_scope
) VALUES (
    'ASSET_MANAGER', 'ASSET', 'SERVER', 'READ_WRITE', 'ANY_DEPT'
);

-- DOC_APPROVER ロールは、DOCUMENT(POLICY) をAPPROVE可能
INSERT INTO PermissionDetail (
    role_code, domain, asset_type, access, department_scope
) VALUES (
    'DOC_APPROVER', 'DOCUMENT', 'POLICY', 'APPROVE', 'ANY_DEPT'
);
```

---

## **10. 運用上の注意**

1. **extensionカラム vs PermissionDetail**  
   - extensionは「カテゴリ単位のフラグ/バージョン」など大まかな情報を持たせるとよい。  
   - 具体的な操作レベルの権限(READ_ONLY/EXECUTEなど)は PermissionDetail で管理しやすい。  

2. **PK `(code_category, code)`**  
   - 同じカテゴリ内で code が重複するとPK重複エラー。  
   - code_division は必須入力でもPKにならないため、  
     「同じ code_division であっても code が違う」ケースを自由に扱える。  

3. **拡張性**  
   - 新ロールを追加: M_CODE にINSERT  
   - 新ドキュメントステータスを追加: 同様にINSERT  
   - 新操作権限を追加: PermissionDetailに行を追加  
   - DBだけ変えれば、アプリケーション再コンパイル不要。  

4. **データ移行**  
   - 旧環境で `(code_category, code_division, code)` をPKとして持っていた場合、移行時に code_division を「通常カラム」に変更しつつ、  
     `(code_category, code)` を中心に重複がないよう調整が必要。  

---

## **11. 結論**

- コードマスタ(M_CODE)を活用した**柔軟な列挙値管理**で、**ISMS / Pマーク / QMS / PCI DSS / SOC2**など多数の規格要件を統合。  
- **PKを `(code_category, code)` に変更**することで、**code_division** を含めた複雑なキー構成の制約を緩和し、より汎用的な拡張ができる。  
- **extension1～10** を活用したフラグやバージョン管理、**PermissionDetail**を利用したRBAC細分化など、大規模企業でのマルチ規格運用を支える。  
- 新しいロールやステータスを追加する際も、DBへINSERTするだけで即時反映可能。  

---

## **自己レビュー**

- 上記の設計書は、PKを `(code_category, code)` とし、code_division を通常カラムとして扱う方針を組み込んだ内容です。  
- フレームワークバージョンを extension1 に入れる例や、すべてのカテゴリの活用事例（組織種別 / ユーザーロール / 監査関連 / リスク関連 など）、  
  PermissionDetail によるロール権限細分化の解説など、これまで示された情報が含まれています。  
- 各カテゴリのINSERT例や extension の使い道などは本文中に示されている通りです。  
- 以上により、ISMS/Pマーク/QMSやその他規格を横断的に運用するためのコードマスタ運用が可能となります。