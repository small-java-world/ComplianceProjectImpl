以下では、**リスク自動提案（自動導出）**に必要な主なテーブルを一覧し、  
**テーブル定義**のサンプルを示します。  
（実際の運用要件に応じてカラムや制約を調整してください。）

---

# **1. テーブル全体図**

```
┌───────────────┐
│ RiskTemplate   │  -- リスクのひな型を管理
│ ---------------│
│ risk_template_id (PK)
│ template_name
│ description
│ severity
└───────────────┘

┌───────────────┐
│ RiskTemplateCondition │
│ ---------------│
│ risk_template_condition_id (PK)
│ risk_template_id (FK→RiskTemplate)
│ attribute_name
│ operator
│ compare_value
│ logical_operator
│ condition_order
└───────────────┘

┌───────────────┐
│ Asset          │  -- 資産を管理
│ ---------------│
│ asset_id (PK)
│ name
│ asset_type_code
│ classification_code
└───────────────┘

┌───────────────┐
│ AssetAttribute │ -- 資産の詳細属性を保持
│ ---------------│
│ asset_attribute_id (PK)
│ asset_id (FK→Asset)
│ confidentiality_level
│ integrity_level
│ availability_level
│ contains_personal_data
└───────────────┘

┌───────────────┐
│ Risk           │ -- 実際に発生しうるリスク(インスタンス)
│ ---------------│
│ risk_id (PK)
│ risk_template_id (FK→RiskTemplate)
│ title
│ description
│ impact_code (または severity)
│ likelihood_code
│ status_code
└───────────────┘

┌───────────────┐
│ AssetRisk      │ -- 資産とリスクの多対多関係を管理
│ ---------------│
│ asset_risk_id (PK)
│ asset_id (FK→Asset)
│ risk_id (FK→Risk)
└───────────────┘
```

- **`RiskTemplate`**: リスクのひな型を管理。どのようなリスクか、重大度はどの程度か等  
- **`RiskTemplateCondition`**: テンプレートの適用条件を複数行で保持 (例: `asset_type_code = 'SERVER' AND confidentiality_level >= 2`)  
- **`Asset` / `AssetAttribute`**: 組織内の資産と、その属性(機密性レベルなど)  
- **`Risk`**: 実際に検出/提案されたリスクインスタンス。どのテンプレート由来かを保持  
- **`AssetRisk`**: 1つのリスクが複数資産に影響、または1つの資産が複数リスクを抱える場面を想定し、多対多で紐づける  

---

# **2. テーブル定義例**

## **2.1 `RiskTemplate`**

```sql
CREATE TABLE RiskTemplate (
    risk_template_id VARCHAR(36) NOT NULL,
    template_name    VARCHAR(200) NOT NULL,
    description      TEXT NOT NULL,
    severity         INT NOT NULL,  -- 1=低,2=中,3=高など
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT PK_RiskTemplate PRIMARY KEY (risk_template_id)
);
```

- **`risk_template_id`**: 主キー (UUIDなど)
- **`template_name`**, **`description`**: テンプレートの名称/内容
- **`severity`**: リスク重大度。影響範囲をざっくり表す

---

## **2.2 `RiskTemplateCondition`**

```sql
CREATE TABLE RiskTemplateCondition (
    risk_template_condition_id VARCHAR(36) NOT NULL,
    risk_template_id           VARCHAR(36) NOT NULL,
    
    attribute_name    VARCHAR(50) NOT NULL, -- ex: 'asset_type_code' / 'confidentiality_level'
    operator          VARCHAR(10) NOT NULL, -- ex: '=', '>=', '<=', '!='
    compare_value     VARCHAR(100) NOT NULL, -- ex: 'SERVER', '2', 'true' など
    logical_operator  VARCHAR(5)  NOT NULL DEFAULT 'AND', -- AND/ORなど
    condition_order   INT NOT NULL DEFAULT 1,  -- 条件適用の順序指定
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT PK_RiskTemplateCondition PRIMARY KEY (risk_template_condition_id),
    CONSTRAINT FK_RiskTemplateCondition_RiskTemplate
        FOREIGN KEY (risk_template_id)
        REFERENCES RiskTemplate(risk_template_id)
);
```

- **複数の条件行**を束ねることで、1つのリスクテンプレートに**AND/OR条件**を設定可能  
- **`attribute_name`**, **`operator`**, **`compare_value`** で「どの属性に対し、どう比較するか」を表す

---

## **2.3 `Asset`**

```sql
CREATE TABLE Asset (
    asset_id            VARCHAR(36) NOT NULL,
    name                VARCHAR(100) NOT NULL,
    asset_type_code     VARCHAR(50)  NOT NULL,
    classification_code VARCHAR(50)  NOT NULL,  -- 情報分類など
    
    -- 場所がある場合 (例: room_id)
    -- room_id            VARCHAR(36) NULL,
    
    description         TEXT NULL,
    created_at          TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT PK_Asset PRIMARY KEY (asset_id)
    -- CONSTRAINT FK_Asset_Room FOREIGN KEY (room_id) REFERENCES Room(room_id)
);
```

- **`asset_type_code`**: "SERVER", "APPLICATION", "DATABASE" など
- **`classification_code`**: "PUBLIC", "INTERNAL", "CONFIDENTIAL", etc.

---

## **2.4 `AssetAttribute`**

```sql
CREATE TABLE AssetAttribute (
    asset_attribute_id     VARCHAR(36) NOT NULL,
    asset_id               VARCHAR(36) NOT NULL,
    confidentiality_level  INT NOT NULL,  -- ex: 1=低,2=中,3=高
    integrity_level        INT NOT NULL,
    availability_level     INT NOT NULL,
    contains_personal_data BOOLEAN NOT NULL DEFAULT false,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT PK_AssetAttribute PRIMARY KEY (asset_attribute_id),
    CONSTRAINT FK_AssetAttribute_Asset
        FOREIGN KEY (asset_id) REFERENCES Asset(asset_id)
);
```

- 資産の詳細なセキュリティ要件(C/I/A)や個人情報フラグなどを保持。  
- **テンプレート条件** と照合してリスクを自動判定する際に使う。

---

## **2.5 `Risk`**

```sql
CREATE TABLE Risk (
    risk_id         VARCHAR(36) NOT NULL,
    risk_template_id VARCHAR(36) NULL,  -- 自動生成元テンプレート (手動登録の場合はNULLもありうる)
    
    title           VARCHAR(200) NOT NULL,
    description     TEXT NULL,
    impact_code     VARCHAR(50) NOT NULL,  -- "HIGH"/"MEDIUM"/"LOW" など
    likelihood_code VARCHAR(50) NOT NULL,  -- "HIGH"/"MEDIUM"/"LOW" など
    status_code     VARCHAR(50) NOT NULL,  -- "未承認", "承認済", etc.
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT PK_Risk PRIMARY KEY (risk_id),
    CONSTRAINT FK_Risk_RiskTemplate
        FOREIGN KEY (risk_template_id)
        REFERENCES RiskTemplate(risk_template_id)
);
```

- **実際に“検出された”リスク**を1件1レコードで管理  
- 自動生成の場合は **`risk_template_id`** をセットし、「どのテンプレートが元か？」を明示

---

## **2.6 `AssetRisk`**

```sql
CREATE TABLE AssetRisk (
    asset_risk_id VARCHAR(36) NOT NULL,
    asset_id      VARCHAR(36) NOT NULL,
    risk_id       VARCHAR(36) NOT NULL,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT PK_AssetRisk PRIMARY KEY (asset_risk_id),
    CONSTRAINT FK_AssetRisk_Asset
        FOREIGN KEY (asset_id) REFERENCES Asset(asset_id),
    CONSTRAINT FK_AssetRisk_Risk
        FOREIGN KEY (risk_id) REFERENCES Risk(risk_id)
);
```

- **資産 : リスク = 多対多(M:N)** を管理する**中間テーブル**  
- 例: あるリスクが複数資産に影響 / 1つの資産が複数リスクに該当 など

---

# **3. 自動提案フロー（再掲）**

1. **リスクテンプレート + 条件** (`RiskTemplate`, `RiskTemplateCondition`) を取得  
2. **資産属性** (`Asset`, `AssetAttribute`) を取得  
3. **条件を判定**: たとえば「サーバかつ機密性レベルが2以上」等  
4. **マッチしたら** → `Risk` レコードをINSERT  
   - `risk_template_id` に紐づけておく  
5. **`AssetRisk`** に `{ asset_id, risk_id }` をINSERT し、  
   「どのリスクがどの資産に該当するか」を保存  

---

# **4. ポイントまとめ**

1. **`RiskTemplate`** と **`RiskTemplateCondition`** で  
   - 「リスクの内容」および「発生条件」を正規化して管理  
2. **`Asset` / `AssetAttribute`** で  
   - 「資産の種類」や「機密性/可用性/個人情報」などの属性を保持  
3. **`Risk`** は  
   - 実際に検出されたリスクインスタンス  
   - テンプレート由来を示すために `risk_template_id` を持つ  
4. **`AssetRisk`** は  
   - 資産とリスクの多対多関係を中間テーブルで管理  

この構成により、**リスクの自動判定**（提案）と**その後の評価/対応**が一貫して管理しやすくなります。  