以下では、これまで提示してきた大規模な**テーブル定義**および**運用シナリオ**に対して、  
DDD（**Domain Driven Design**）の観点から** bounded context（境界づけられたコンテキスト）**をどのように整理できるかを考えてみます。  

DDDでは、大きなビジネスドメインを**複数のサブドメイン**に切り分け、それぞれを**bounded context**として実装・運用するのが一般的です。  
同一の巨大DBスキーマで一体運用する場合でも、**アプリケーション層**や**サービス層**で文脈の分離を明確にすることで、  
**集約(aggregate)** の境界や**ユビキタス言語**の整合性を保ちやすくなります。

---

# 1. 大枠のサブドメイン例

ここでは以下のような**7つ程度**のサブドメイン（bounded context）を想定します。  

1. **\[*組織・認証管理*\]** *OrganizationContext*  
   - 組織(Organization)、部署(Department)、ユーザ(User)など**組織構造とアカウント管理**に特化。  
   - 役職やロールなどの**権限(RBAC)**、`PermissionDetail` などの詳細もここに含める。  
   - M_CODE を参照するが、**M_CODE**自体は独立運用（ReferenceDataContext的役割）とする場合が多い。

2. **\[*アセット管理*\]** *AssetContext*  
   - **資産(Asset)とその属性(AssetAttribute)** に関する管理。  
   - 物理的階層(建物・フロア・部屋)との紐づき、およびオーナー(AssetOwner)など。  
   - セキュリティ評価(C/I/Aなど)は**AssetAttribute**を**別DB**で管理しているが、  
     ドメイン的には**「アセット管理」**として一つのサブドメインを構成する（物理的DB分割は別問題）。

3. **\[*リスク管理*\]** *RiskManagementContext*  
   - リスク(Risk)、リスクアセスメント(RiskAssessment)、リスク対応計画(RiskTreatmentPlan)など、  
     **組織のリスクを特定し、評価し、対応策を計画/実行する**プロセスを担当。  
   - 「どの資産(Asset)がどのリスク(Risk)に紐づくか」は **AssetRisk** で管理。  
   - 要求事項(Requirement)とのマッピング(RiskRequirement)もここに含む。  
   - **プロジェクト**とは一定の連携がある（例: `Risk.project_id`）が、リスク管理の核はこのサブドメインで完結。

4. **\[*コンプライアンス/認証プロジェクト管理*\]** *ComplianceContext*  
   - コンプライアンスプロジェクト(ComplianceProject)、適用範囲(ProjectScope)、  
     フレームワーク(ProjectFramework)など、**ISOやPマーク等の認証取得に向けたプロジェクト運営**を行う文脈。  
   - 要求事項(Requirement)やフレームワーク(ComplianceFramework)もこのコンテキストに含める。  
   - ImplementationTask（「要求事項を満たすための対応タスク」）や証拠(Evidence)も、  
     「Complianceプロジェクト内で進行する実装アクション」として本サブドメインに含む。  

5. **\[*監査・不適合管理*\]** *AuditContext*  
   - 監査(Audit)・監査スコープ(AuditScope)・不適合(NonConformity)・是正措置(CorrectiveAction)・評価レポート(AssessmentReport)など。  
   - 内部監査/外部監査/サーベイランスなどのフローを扱い、**不適合→是正措置**の流れを一括管理。  
   - コンプライアンスプロジェクトやリスク管理とも密接に関連はあるが、**監査特有のドメインロジック**をまとめる形。  

6. **\[*文書管理*\]** *DocumentManagementContext*  
   - 文書(Document)・文書バージョン(DocumentVersion)・承認ワークフロー(ApprovalWorkflow) などを扱う。  
   - 「文書カテゴリ×部署×承認ロール」マッピング(DocCategoryDeptMapping)もここ。  
   - このサブドメインでは「文書ライフサイクル」「承認プロセス」を中心に**固有の用語・概念**が存在。  

7. **\[*教育・トレーニング*\]** *TrainingContext*  
   - TrainingProgram, TrainingRecord（誰がどの研修をいつ受け、合格/不合格）を管理する文脈。  
   - セキュリティ教育や監査員教育など**教育プログラム全般**を扱う。  
   - リスク管理や監査(不適合是正)から「教育不足がリスク」と指摘されるシナリオとの協調があるが、  
     教育プロセス自体は独自のサブドメインとして切り出せる。

---

## 2. 参照データや汎用マスタ (M_CODE)

- **M_CODE** は「列挙値管理」「コード名・ラベル管理」を担う。  
- DDD的には**「ReferenceDataContext」**（あるいは**「SharedKernel」**の一部）として扱われることが多い。  
- ただし、**Join禁止・キャッシュ参照**の方針であれば、厳密には各コンテキストが**アプリケーション起動時にキャッシュ**を読み込み、  
  それぞれが**M_CODE**を参照（あるいは外部API呼び出し）する形を取る。  
- M_CODEの中には「USER_ROLE」「PROJECT_STATUS」など**複数のサブドメイン**にまたがる概念が混在するため、  
  もしDDDをより厳密にやるなら**コンテキストごとにEnum or コード管理**を分割する手もある。  
  しかし運用上まとめて管理するメリットが大きい場合は、**統一の「マスタ管理コンテキスト」**として置くのが実務的。

---

## 3. 各コンテキストの例

### 3-1. **OrganizationContext** (組織 / アカウント・権限)

- **主な集約**  
  - **User**: ユーザエンティティ  
    - ユーザID, 氏名, メール, `role_code` など  
    - **department_id**（部署への所属）  
    - Password関連(ハッシュ)  
  - **Department**: 部署エンティティ  
    - 階層構造を表現(parent_id)  
  - **PermissionDetail**: 追加のアクセスコントロール。  
  - **Organization**: 会社(クライアント企業など)を表す上位概念。  
- **主なユースケース**  
  - 新規ユーザ登録 → role_code 付与 → `PermissionDetail` でドメイン別アクセス範囲(ANY_DEPT / OWN_DEPTなど)を設定  
  - 部署異動 → department更新 & `PermissionDetail`影響範囲確認  
- **外部コンテキストとの関係**  
  - たとえば**ComplianceContext** から「project_id → projectに紐づくorganization_id → そこに所属するUserやDepartmentを参照」する場合がある  
  - ただしDDD的には**バウンデッドコンテキストの境界越え**となるため、  
    普通は**OrganizationContext**が何らかの**ドメインサービス**や**API**を提供して、  
    別のコンテキストがそれを呼ぶ形になる（またはUserやDepartmentのIDのみ受け渡す）。

### 3-2. **AssetContext** (資産管理)

- **主な集約**  
  - **Asset**: 資産エンティティ  
    - `name`, `description`, `asset_type_code`, `classification_code` など  
    - `project_id` → どのプロジェクトに所属する資産か(ただし物理的には共通の可能性も)  
    - `room_id` → 物理的設置場所(連携先: BuildingContext or FacilityContext)  
  - **AssetAttribute**: 機密性/可用性/個人情報フラグなど**セキュリティ属性**  
    - 物理的に**別DB**でも、**ドメイン論的**には**同じサブドメイン(Asset管理)**  
  - **AssetOwner**: 複数ユーザがオーナーになれる(責任区分など)  
- **主なユースケース**  
  - 資産のライフサイクル(登録/更新/廃棄)管理  
  - 資産属性の更新(C/I/A変更など) → リスク評価トリガ  
  - 部屋(Room)やフロア(Floor)との紐づけ → 物理セキュリティ上の範囲確認  
- **外部コンテキストとの関係**  
  - **RiskManagementContext** で `AssetRisk` を介してつながる  
  - **AuditContext** で監査対象資産を確認するときに**Asset**参照が必要 → 何らかのAPI呼び出しや shared ID などで連携  

### 3-3. **RiskManagementContext** (リスク管理)

- **主な集約**  
  - **Risk**: リスクエンティティ  
  - **RiskAssessment**: リスク評価(HIGH_RISK, MEDIUM_RISKなど)  
  - **RiskTreatmentPlan**: リスク対応計画(回避/低減/移転/受容など)  
  - **AssetRisk**: 資産とリスクの多対多関係(中間テーブル)  
  - **RiskRequirement**: リスクと要求事項を結びつける(ISO 27001の特定コントロールに紐づけ)  
- **主なユースケース**  
  - 資産属性変更(AssetContext) → リスクの再評価(本サブドメイン)  
  - リスク発見 → TreatmentPlan策定 → 実施状況をモニタリング  
- **外部コンテキストとの関係**  
  - **ComplianceContext**: 要求事項(Requirement)を参照し、リスク対応策の根拠とする  
  - **AssetContext**: どの資産がどのリスクか  
  - **AuditContext**: 監査で発見された不適合に対応する過程で、リスク再評価が発生するシナリオなど  

### 3-4. **ComplianceContext** (コンプライアンス/認証取得)

- **主な集約**  
  - **ComplianceProject**: 認証プロジェクト(開始日/終了日/ステータスなど)  
  - **ProjectScope**: どの範囲(部署・サービスなど)が対象か  
  - **ProjectFramework**: ISO27001、PCI DSS 等のフレームワークを紐づけ  
  - **ComplianceFramework** + **Requirement**: フレームワークそのものの要求事項  
  - **ImplementationTask**: 特定Requirementを満たすためのタスク(担当者/期限/証拠)  
  - **Evidence**: 実装結果の証拠(ファイル/URL)  
- **主なユースケース**  
  - プロジェクト開始 → 適用スコープ登録 → フレームワーク選択  
  - 要求事項に対するImplementationTaskを管理 → 担当者がEvidenceを登録 → 監査前にギャップを埋める  
- **外部コンテキストとの関係**  
  - **RiskManagementContext**: リスクにもとづき、どのRequirementを適用するか  
  - **AuditContext**: 監査(外部/内部)と連動しているが、監査自体の流れはAuditContextで扱う  
  - **DocumentManagementContext**: 文書としてポリシー/手順書を整備 → Evidenceにも利用  

### 3-5. **AuditContext** (監査・不適合・是正)

- **主な集約**  
  - **Audit**: 監査(内部/外部/Stage1/Stage2等)  
  - **AuditScope**: 監査対象範囲  
  - **AssessmentReport**: 監査レポート(結論/発行日)  
  - **NonConformity**: 不適合(重大度やステータス)  
  - **CorrectiveAction**: 是正措置(不適合ごとに立案し、担当者や期日を持つ)  
- **主なユースケース**  
  - 監査計画 → 実施 → レポート作成 → 不適合指摘 → 是正措置 → フォローアップ  
  - ここで出た不適合が**ComplianceContext**(実装タスク)や**RiskManagementContext**(リスク再評価)に影響  
- **外部コンテキストとの関係**  
  - **ComplianceContext**: Auditでの不適合 → ImplementationTaskへつなぐ  
  - **RiskManagementContext**: 不適合内容が新たなリスクになりうる（または既存リスクを再評価）  

### 3-6. **DocumentManagementContext** (文書管理・承認WF)

- **主な集約**  
  - **Document**: 文書メタデータ(カテゴリ、所属部署など)  
  - **DocumentVersion**: バージョン管理(ドラフト/レビュー/承認済みなどのライフサイクル)  
  - **ApprovalWorkflow**: 承認者とステータス(PENDING/APPROVED/REJECTED等)  
  - **DocCategoryDeptMapping**: カテゴリ×部署×承認ロールで承認フローを自動生成する仕組み  
- **主なユースケース**  
  - 新規文書のドラフト → レビュー → 承認 → 公開 → 改訂 …  
  - ISMS文書や手順書などを**Evidence**として利用する場合は**ComplianceContext**との連携。  
- **外部コンテキストとの関係**  
  - **ComplianceContext**: Evidence登録の際にDocumentへのリンクを張るなど。  
  - **OrganizationContext**: 承認者(User)のロールを参照したり、`department_id`による制御を行う。  

### 3-7. **TrainingContext** (教育・トレーニング)

- **主な集約**  
  - **TrainingProgram**: 研修プログラム(内容/期間/対象)  
  - **TrainingRecord**: ユーザがいつ受講し、結果どうだったか(合格/失敗/免除など)  
- **主なユースケース**  
  - 新しいセキュリティ教育を作成 → 全社員へ案内 → 受講結果を集計 → リスク対応(「教育不備」リスクを低減)  
- **外部コンテキストとの関係**  
  - **AuditContext**: 監査で「教育受講率が低い」→ 不適合 → 是正措置 → トレーニング強化  
  - **OrganizationContext**: Userの所属部署を参照し、受講状況を管理  

---

## 4. 相互連携とコンテキスト間統合

### 4-1. コンテキスト間のID参照

- 各コンテキストを物理的に**独立DB**に分けるか、同一DBの**論理的スキーマ**に分けるかは選択肢。  
- いずれにせよDDDでは、**他のコンテキストのエンティティ**を必要とするときは**ID**などの**薄い情報のみ**受け取るか、  
  専用の**翻訳(anticorruption layer)** や**API呼び出し**で連携する。  
- たとえば**AssetContext**の`Asset`を**RiskManagementContext**が使うときは、  
  `asset_id`だけ受け取り、必要最小限の属性を読み込む形（アプリ層でAPI or リポジトリ呼び出し）。

### 4-2. Shared Kernel (共有カーネル)

- もしどうしても複数コンテキストで**同じ概念を完全に共有**する必要があるなら、  
  「**Shared Kernel**」として**限定的に**スキーマやモデルを共有することもある。  
- ただしDDDでは、むやみに**多数のShared Kernel**を作ると境界が曖昧になりがちなので注意。

### 4-3. 物理的DB分割の例

- 「AssetAttributeは別DB」という要件があるように、  
  物理的には**AssetContext**内の一部テーブルだけ別サーバ/別DBに置くケースもある。  
- ドメイン的には同じ`AssetContext`だが、インフラ構成として**データベースレベル**で分割されているだけ。  
- **Transactional consistency** の確保などは、**アプリケーション層**や**メッセージング**で工夫する必要がある。  

---

## 5. まとめ

上記のように、**大規模な統合DBスキーマ**でも、DDDの観点から  
- 組織管理(OrganizationContext)  
- 資産管理(AssetContext)  
- リスク管理(RiskManagementContext)  
- コンプライアンス(ComplianceContext)  
- 監査(AuditContext)  
- 文書管理(DocumentManagementContext)  
- 教育管理(TrainingContext)  
- （参照データマスタ(ReferenceDataContext) … M_CODE など）  

といった**bounded context**に分割して考えると、それぞれの**責務・ユビキタス言語**を明確にし、  
**集約(aggregate)** や**エンティティ**、**リポジトリ**をサブドメイン単位で実装できるため、**変更影響**を最小化しやすくなります。  

- **AssetAttributeを別DB**にしたい要件も、DDD的には「AssetContext」に包含し、  
  物理実装として**DBを分ける**かどうかは**インフラ構成**の問題。  
- **M_CODE(汎用マスタ)** は、DDDだと「一つのコンテキストに集約」するか「Shared Kernelに置くか」「各コンテキストにEnumとして分割するか」などの選択肢がありますが、  
  実務では「**運用上のメリットが大きい**」なら一括管理でもOK。  
- コンテキスト間で**ドメインイベント**や**API連携**を活用し、**疎結合**な統合を目指すのが理想です。

このようにDDDを適用することで、**巨大なテーブル群を一枚岩で運用するリスク**を下げ、  
**組織変更**や**新たな監査要件**などの変化にも柔軟かつメンテナブルに対応できるようになります。