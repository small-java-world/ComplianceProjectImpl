以下では、**PermissionDetail** テーブルに `department_scope` カラムを追加し、**「任意の部門の資産や承認ができるかどうか」** を管理する方法（パターン2.1）を詳しく示します。  
すでにご提案いただいている **PermissionDetail** の構造に、**department_scope** を新たに加えた設計例と、  
テーブルサンプルデータ・アクセス判定ロジックの例を挙げます。

---

# 1. テーブル定義例

```sql
CREATE TABLE PermissionDetail (
    permission_detail_id BIGINT AUTO_INCREMENT NOT NULL,
    permission_id        BIGINT NOT NULL,
    domain              VARCHAR(50) NOT NULL,   -- 例: "ASSET", "DOCUMENT", ...
    asset_type          VARCHAR(50) NULL,       -- 例: "SERVER", "DOCUMENT", ...
    access              VARCHAR(50) NOT NULL,   -- 例: "READ_WRITE", "APPROVE", ...
    department_scope    VARCHAR(50) NOT NULL,   -- 部門スコープ管理用

    PRIMARY KEY (permission_detail_id),
    CONSTRAINT FK_PermissionDetail_Permission
        FOREIGN KEY (permission_id) REFERENCES Permission(permission_id)
);
```

- **department_scope** カラム：  
  - 「このPermissionDetailは、どの部門に対して有効か」を表す文字列。  
  - 例: 
    - `"ANY_DEPT"` : 全社（任意の部門）対象  
    - `"OWN_DEPT"` : ログインユーザの所属部門(や下位部門)に限定  
    - `"DEPT_XYZ"` : 部門IDが `"DEPT_XYZ"` のところだけ  
    - `"MULTI:DEPT_A,DEPT_B"` : 複数部門を並べるケース(実装によってはセミコロン区切りやJSONなど工夫)  

> 部門スコープが高度になると、**1行1部門**で管理したい場合もありますが、  
> ここでは**単一カラム**で示す方式を想定しています。

---

# 2. サンプルデータ

以下、**任意の部門**に対して資産操作や文書承認が可能な例と、特定の部門だけ許可する例をまとめました。

| permission_detail_id | permission_id | domain    | asset_type       | access      | department_scope | 補足                                                                             |
|---------------------:|--------------:|:---------:|:----------------:|:-----------:|:----------------:|:---------------------------------------------------------------------------------|
| 1                    | 1001          | ASSET     | SERVER          | READ_WRITE  | ANY_DEPT         | どの部門に属するサーバ資産でも読み書き可能 (全社横断)                            |
| 2                    | 1001          | ASSET     | DOCUMENT        | READ_ONLY   | OWN_DEPT         | ログインユーザの所属部門（および必要に応じ下位部門）にある文書資産のみ参照可      |
| 3                    | 1001          | AUDIT     | INTERNAL        | EXECUTE     | DEPT_AUDIT       | 部門ID="DEPT_AUDIT" に所属する対象だけ監査実行可 (特定部門向け)                  |
| 4                    | 1001          | DOCUMENT  | POLICY          | APPROVE     | ANY_DEPT         | 全社どの部門のポリシー文書でも承認操作を実施できる                                |
| 5                    | 1001          | DOCUMENT  | PROCEDURE       | READ_WRITE  | DEPT_SEC         | 「DEPT_SEC」部門の手順書だけ編集可                                               |
| 6                    | 1001          | DOCUMENT  | GUIDELINE       | READ_ONLY   | MULTI:DEPT_ABC,DEPT_DEF | 部門ABC, DEFだけに限り参照可 (複数部門を記載)                                   |
| 7                    | 1001          | ASSET     | MOBILE_DEVICE   | READ_WRITE  | ANY_DEPT         | モバイルデバイスについても全社横断で編集可                                        |
| 8                    | 1001          | DOCUMENT  | FORM            | APPROVE     | OWN_DEPT         | 自部署のフォーム文書だけ承認可能                                                 |

> - 例示のために `"ANY_DEPT"`, `"OWN_DEPT"`, `"DEPT_SEC"`, `"MULTI:DEPT_ABC,DEPT_DEF"` など複数の書き方を挙げています。  
> - 実際の運用では `"ANY_DEPT"`, `"OWN_DEPT"` などの定数値、または**固定的なルール**を運用ドキュメントで定義し、  
>   **アプリ側の判定コード**と整合をとるようにしてください。

---

# 3. アクセス判定ロジック例

アクセス判定時には、**domain, asset_type, access** の3要素だけでなく、**department_scope** もチェックします。  
たとえば**対象の部門ID**が `"DEPT_ABC"` だった場合、部門スコープがどう記載されていればOKかを判定します。

### 擬似コード

```pseudo
function canAccess(user, targetObject):
    // 1) userロールに紐づく permission_id を特定 (RolePermission 等から)
    // 2) permission_id から PermissionDetail 一覧を取得
    for each detail in permissionDetailList:

        // domain / asset_type / access が要求とマッチするか
        if detail.domain       == targetObject.domain 
           and detail.asset_type == targetObject.assetType
           and detail.access   == requestedAccess
        then
            // 部門スコープ判定
            if matchDepartmentScope(detail.department_scope, user.department_id, targetObject.department_id) 
            then
                return true
    
    return false

// department_scope の具体判定
function matchDepartmentScope(scopeString, userDeptId, targetDeptId):
    switch scopeString:
        case "ANY_DEPT":
            return true

        case "OWN_DEPT":
            // 例: 同じ部門 or 下位部門ならOK
            return isSameOrSubDept(userDeptId, targetDeptId)

        default:
            // "DEPT_SEC" のような単一部門IDか 
            // "MULTI:DEPT_ABC,DEPT_DEF" のようにカンマ区切りか
            if scopeString startsWith "MULTI:":
                multiPart = (scopeString without "MULTI:").split(",")
                if targetDeptId in multiPart:
                    return true
                else
                    return false
            else:
                // 単一部門IDの場合
                return (scopeString == targetDeptId)
```

### ポイント

- `"ANY_DEPT"` : どんな部門でもOK → return true  
- `"OWN_DEPT"` : ログインユーザ所属部門(＋必要なら下位部門)と対象部門が合致すればOK  
- `"DEPT_XXX"` : 特定1部門だけ  
- `"MULTI:DEPT_A,DEPT_B"` : 複数部門IDを列挙→カンマ分割し `targetDeptId` が含まれるか判定  

> もし部門階層構造が複雑で、親・子を含むスコープに対応したいなら、**isSameOrSubDept** の実装で**組織階層テーブル**を辿り、  
> どちらかが相手を含むかどうかを判定する仕組みを用意すればOKです。

---

# 4. 任意の部門の資産や文書承認ができる設定

要件が「**任意の部門の資産や承認を可能にしたい**」なら、  
**PermissionDetail**.department_scope を `"ANY_DEPT"` とすれば実現可能です。

- 例: `domain="ASSET", asset_type="SERVER", access="READ_WRITE", department_scope="ANY_DEPT"`  
  → どの部門が所有するサーバ資産でも編集可能になる。  
- 例: `domain="DOCUMENT", asset_type="POLICY", access="APPROVE", department_scope="ANY_DEPT"`  
  → 全部門のポリシー文書を承認操作できる。

---

# 5. まとめ

1. **PermissionDetail に department_scope を追加**することで、**どの部門に対して権限が有効か**を1行ごとに指定可能。  
2. **"ANY_DEPT" / "OWN_DEPT" / "DEPT_XXXX" / "MULTI:..."** などの文字列ルールを定義し、  
   アクセス判定時に**「対象の部門IDがスコープに含まれるか」**を判定する。  
3. **任意の部門の資産や承認**を許可したい場合は、**department_scope="ANY_DEPT"** のレコードを作ればよい。  
4. 実際の実装では、**カンマ区切り**や**JSON**、あるいは**サブテーブル**などさまざまな方法がありますが、  
   **単一カラムで文字列管理**するなら、上記のようなルール運用で十分に柔軟な設定が可能です。


   以下に、**permission_detail_id=81～120** の **40件**を新たに追加します。  
すべて例として `permission_id=1001` に紐づけており、ドメインや操作(アクセス種別)は**これまで出ていない例**を中心にバリエーションを広げています。

```markdown
| permission_detail_id | permission_id | domain               | asset_type              | access       | 補足説明                                                                                                |
|---------------------:|--------------:|:--------------------:|:-----------------------:|:------------:|:--------------------------------------------------------------------------------------------------------|
| 81                   | 1001          | QUALITY             | QMS_DOCUMENT           | READ_WRITE   | 品質マニュアルやQMS関連文書を参照・編集可                                                                |
| 82                   | 1001          | QUALITY             | QMS_AUDIT             | EXECUTE      | 品質マネジメントシステム(QMS)内部監査を実施できる                                                        |
| 83                   | 1001          | QUALITY             | CAPA                   | READ_WRITE   | 是正/予防措置(CAPA)の登録・更新可                                                                        |
| 84                   | 1001          | SAFETY              | SAFETY_INCIDENT        | CREATE       | 安全管理上のインシデント(事故/ヒヤリハット)を新規起票                                                    |
| 85                   | 1001          | SAFETY              | HAZARD_REGISTER        | READ_ONLY    | 潜在危険源(ハザード)の台帳を参照のみ可                                                                   |
| 86                   | 1001          | SAFETY              | CONTROL_MEASURES       | READ_WRITE   | 安全対策(防護具や手順等)を登録/更新可                                                                    |
| 87                   | 1001          | ENVIRONMENT         | EMS_DOCUMENT           | READ_WRITE   | 環境マネジメントシステム(EMS)関連文書を参照・編集可                                                       |
| 88                   | 1001          | ENVIRONMENT         | WASTE_MANAGEMENT       | EXECUTE      | 廃棄物管理(排出量や処理状況)に関する処理を実行可                                                          |
| 89                   | 1001          | ENVIRONMENT         | COMPLIANCE_LOG         | READ_ONLY    | 環境規制の遵守状況ログを参照のみ可                                                                       |
| 90                   | 1001          | SOCIAL              | CSR_POLICY             | APPROVE      | CSR(企業の社会的責任)ポリシーを承認可                                                                     |
| 91                   | 1001          | SOCIAL              | STAKEHOLDER_ENGAGEMENT | READ_WRITE   | ステークホルダー(地域/顧客等)との協議・活動記録を作成/更新可                                              |
| 92                   | 1001          | SECURITY            | SIEM                   | MONITOR      | SIEM(Security Information and Event Management)のアラートを監視                                          |
| 93                   | 1001          | SECURITY            | MFA_SETUP              | EXECUTE      | MFA(多要素認証)の設定・展開を実施可                                                                       |
| 94                   | 1001          | SECURITY            | SECURITY_BASELINE      | REVIEW       | セキュリティベースライン(基準構成)をレビュー(差分チェック)可                                              |
| 95                   | 1001          | SECURITY            | VA_SCAN                | EXECUTE      | 脆弱性スキャン(VA)を実行できる                                                                            |
| 96                   | 1001          | CLOUD               | INSTANCE_MANAGEMENT    | READ_WRITE   | クラウド上のインスタンス(EC2など)の作成/更新可                                                            |
| 97                   | 1001          | CLOUD               | IAM_POLICIES           | APPROVE      | クラウドIAM(ポリシー/ロール)変更を承認可                                                                   |
| 98                   | 1001          | DATA                | DATA_CLASSIFICATION    | READ_WRITE   | データ分類(機密/社外秘/一般など)の設定・更新可                                                            |
| 99                   | 1001          | DATA                | DATA_RETENTION         | EXECUTE      | データ保持期間の適用/アーカイブ実行可                                                                      |
| 100                  | 1001          | DATA                | DATA_DISPOSAL          | APPROVE      | データ廃棄(シュレッダー/削除)プロセスを承認可                                                             |
| 101                  | 1001          | COMPLIANCE          | ISO27001               | REVIEW       | ISMS (ISO27001)の文書やプロセスをレビュー可                                                                |
| 102                  | 1001          | COMPLIANCE          | ISO9001                | READ_ONLY    | QMS(ISO9001)関連文書を参照のみ                                                                            |
| 103                  | 1001          | COMPLIANCE          | PCI_DSS                | EXECUTE      | PCI DSS準拠手続き(ネットワークスキャン等)を実行可                                                          |
| 104                  | 1001          | COMPLIANCE          | HIPAA                  | READ_ONLY    | HIPAA(米国医療情報保護)関連ドキュメントを参照のみ                                                         |
| 105                  | 1001          | COMPLIANCE          | GDPR                   | REVIEW       | GDPR(欧州個人情報保護)に関するドキュメントをレビュー可                                                    |
| 106                  | 1001          | COMPLIANCE          | SOC2                   | READ_ONLY    | SOC2(監査報告書)に関する要件・レポートを参照のみ                                                           |
| 107                  | 1001          | GOVERNANCE          | BOARD_MINUTES          | READ_WRITE   | 取締役会議事録を作成/更新可                                                                                |
| 108                  | 1001          | GOVERNANCE          | POLICY_REVIEW          | EXECUTE      | 組織全体のポリシーレビュー(改定プロセス)を実行可                                                           |
| 109                  | 1001          | GOVERNANCE          | COMMITTEE_REPORT       | APPROVE      | 委員会レポートを承認できる                                                                                |
| 110                  | 1001          | OPEN_SOURCE         | LICENSE_COMPLIANCE     | REVIEW       | OSSライセンスのコンプライアンス状況をレビュー可                                                            |
| 111                  | 1001          | OPEN_SOURCE         | REPOSITORY_AUDIT       | EXECUTE      | OSSリポジトリの監査(脆弱ライブラリ検出など)を実施可                                                         |
| 112                  | 1001          | OPEN_SOURCE         | THIRD_PARTY_LIB        | READ_WRITE   | サードパーティ製ライブラリ情報を登録/更新可                                                                |
| 113                  | 1001          | METRICS             | KPI_COLLECTION         | READ_WRITE   | KPI指標の収集・登録を行える                                                                               |
| 114                  | 1001          | METRICS             | PERFORMANCE_SCORECARD  | READ_ONLY    | パフォーマンススコアカードを参照のみ可                                                                     |
| 115                  | 1001          | METRICS             | ALERT_THRESHOLD        | APPROVE      | KPIアラート閾値の設定変更を承認可                                                                          |
| 116                  | 1001          | SERVICE_DESK        | TICKET                 | READ_WRITE   | サービスデスクのチケットを作成/更新可                                                                      |
| 117                  | 1001          | SERVICE_DESK        | KNOWN_ERROR_DB         | EXECUTE      | Known Error Database(KEDB)に登録された情報を活用し、問題解決を実行可                                        |
| 118                  | 1001          | SERVICE_DESK        | MAJOR_INCIDENT         | ESCALATE     | 重大インシデントを上位管理者へエスカレーションできる                                                       |
| 119                  | 1001          | SERVICE_DESK        | CHANGE_APPROVAL        | APPROVE      | 変更要求(チェンジリクエスト)の承認操作可                                                                   |
| 120                  | 1001          | SERVICE_DESK        | REQUEST_FULFILLMENT    | READ_ONLY    | サービスリクエスト(申請)の対応状況を参照のみ                                                                |
```

この追加分(81～120)により、**合計120件**のサンプルデータが揃いました。  
今回の40件は、品質管理(QMS)、安全(SAFETY)、環境(EMS)、ソーシャル(CSR)、クラウド、オープンソース、ガバナンス、メトリクス、サービスデスクなど、  
**ISMS以外の他規格・他領域**も含めた幅広い管理ドメインを想定しており、大規模企業の統合リスク・コンプライアンス管理にも対応可能な例となっています。